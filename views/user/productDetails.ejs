<%- include('../layout/user/header.ejs') %>

<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="/user/home" rel="nofollow">Home</a>
                <span></span><a href="/shop">Shop</a>
                <span></span> Product Detail
            </div>
        </div>
    </div>
    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="product-detail accordion-detail">
                        <div class="row mb-50">
                            <div class="col-md-6 col-sm-12 col-xs-12">
                                <div class="detail-gallery">
                                    <span class="zoomWindowContainer style="width: 400px;" class="fi-rs-search"></span>
                                    <!-- MAIN SLIDES -->
                                    <div class="product-image-slider">
                                        <% if (products && products.images && products.images.length > 0) { %>
                                            <% products.images.forEach((image, index) => { %>
                                                <figure class="border-radius-10">
                                                    <img src="/static/uploads/<%= image.filename %>" alt="Slide <%= index + 1 %>" style="width:650px; height: 400%;">
                                                </figure>
                                            <% }) %>
                                        <% } %>
                                    </div>
                                    <!-- THUMBNAILS -->
                                    <div class="slider-nav-thumbnails pl-15 pr-15">
                                        <% if (products && products.images && products.images.length > 0) { %>
                                            <% products.images.forEach((image, index) => { %>
                                                <div><img src="/static/uploads/<%= image.filename %>" alt="Slide <%= index + 1 %>" alt="product image"></div>
                                            <% }) %>
                                        <% } %>
                                    </div>
                                </div>
                                <!-- End Gallery -->
                            </div>
                            <div class="col-md-6 col-sm-12 col-xs-12">
                                <div class="detail-info">
                                    <h2 class="title-detail">
                                        <%= products.productName %>
                                    </h2>
                                    <div class="product-detail-rating">
                                        <div class="product-rate-cover text-end">
                                            <div class="product-rate d-inline-block">
                                                <div class="product-rating" style="width:90%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="clearfix product-price-cover">
                                        <div class="product-price primary-color float-left">
                                            <ins><span class="text-brand">Rs. <%= products.salesPrice %></span></ins>
                                            <ins><span class="old-price font-md ml-15">Rs. <%= products.regularPrice %></span></ins>
                                        </div>
                                    </div>
                                    <div class="bt-1 border-color-1 mt-15 mb-15"></div>
                                    <div class="short-desc mb-30">
                                        <p><%= products.description %></p>
                                    </div>
                                    <div class="product_sort_info font-xs mb-30">
                                        <ul>
                                            <li class="mb-10"><i class="fi-rs-crown mr-5"></i> 1 Year AL Jazeera Brand Warranty</li>
                                            <li class="mb-10"><i class="fi-rs-refresh mr-5"></i> 30 Day Return Policy</li>
                                            <li><i class="fi-rs-credit-card mr-5"></i> Cash on Delivery available</li>
                                        </ul>
                                    </div>

                                    <div class="detail-extralink">
                                        <form class="cart clearfix" id="addToCartForm" data-product-id="<%= products._id %>">
                                            <div class="cart-btn d-flex mb-50">
                                                <div class="quantity">
                                                    <p>Qty</p>
                                                    <input type="number" class="qty-val" id="qty" step="1" min="1" max="10" name="quantity" value="1" oninput="validateQuantity(this)" />
                                                </div>
                                            </div>
                                            
                                            <input type="hidden" id="available-stock" value="<%= products.quantity %>">
                                            

                                            <div class="product-extra-link2">
                                                <% if (products.quantity < 1) { %>
                                                    <button type="button" class="button button-add-to-cart out-of-stock">Out Of Stock</button>
                                                <% } else { %>
                                                    <button type="button" class="button button-add-to-cart" onclick="addToCartDetails('<%= products._id %>')">Add to cart</button>
                                                <% } %>
                                                <a aria-label="Add To Wishlist" class="action-btn hover-up" href="#" onclick="addTowishlist('<%= products._id %>')"><i class="fi-rs-heart"></i></a>
                                                <a aria-label="Compare" class="action-btn hover-up" href="shop-compare.html"><i class="fi-rs-shuffle"></i></a>
                                            </div>
                                        </form>
                                    </div>
                                    <ul class="product-meta font-xs color-grey mt-50">
                                        <li>
                                            Availability:
                                            <span class="<%= products.quantity < 1 ? 'text-danger' : 'text-success' %> ml-5 available-stock-text">
                                                <%= products.quantity %> Items In Stock
                                            </span>
                                        </li>
                                    </ul>
                                </div>
                                <!-- Detail Info -->
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-10 m-auto entry-main-content">
                                <h2 class="section-title style-1 mb-30">Description</h2>
                                <span class="wp-block-separator is-style-wide"><%= products.description %></span>
                                <div class="description mb-50">
                                    <hr class="wp-block-separator is-style-dots">
                                    <p>This product comes with a 12 months warranty against manufacturing defects. Fabrics, leatherettes, and leathers, if used, will not be covered by the above Warranty. Only our Luxe range of fabrics will be covered under a 36 months warranty.</p>
                                    <h4 class="mt-30">Packaging & Delivery</h4>
                                    <hr class="wp-block-separator is-style-wide">
                                    <p>Less lion goodness that euphemistically robin expeditiously bluebird smugly scratched far while thus cackled sheepishly rigid after due one assenting regarding censorious while occasional or this more crane went more as this less much amid overhung anathematic because much held one exuberantly sheep goodness so where rat wry well concomitantly.</p>
                                    <p>Scallop or far crud plain remarkably far by thus far iguana lewd precociously and and less rattlesnake contrary caustic wow this near alas and next and pled the yikes articulate about as less cackled dalmatian in much less well jeering for the thanks blindly sentimental whimpered less across objectively fanciful grimaced wildly some wow and rose jeepers outgrew lugubrious luridly irrationally attractively dachshund.</p>
                                </div>

                                <div class="social-icons single-share">
                                    <ul class="text-grey-5 d-inline-block">
                                        <li><strong class="mr-10">Share this:</strong></li>
                                        <li class="social-facebook"><a href="#"><img src="assets/imgs/theme/icons/icon-facebook.svg" alt=""></a></li>
                                        <li class="social-twitter"><a href="#"><img src="assets/imgs/theme/icons/icon-twitter.svg" alt=""></a></li>
                                        <li class="social-instagram"><a href="#"><img src="assets/imgs/theme/icons/icon-instagram.svg" alt=""></a></li>
                                        <li class="social-linkedin"><a href="#"><img src="assets/imgs/theme/icons/icon-pinterest.svg" alt=""></a></li>
                                    </ul>
                                </div>
                                <h3 class="section-title style-1 mb-30 mt-30">Reviews (3)</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script src="https://unpkg.com/zooming/build/zooming.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>

<script>
    const MAX_QUANTITY_PER_PERSON = 10;
    const availableStock = document.getElementById('available-stock').value;

    function validateQuantity(input) {
        let value = parseInt(input.value);

        if (value < 1) {
            input.value = 1;
        } else if (value > availableStock) {
            input.value = availableStock;
            Swal.fire({
                title: 'Out of Stock!',
                text: `Only ${availableStock} items are available in stock.`,
                icon: 'error',
                confirmButtonText: 'OK'
            });
        } else if (value > MAX_QUANTITY_PER_PERSON) {
            input.value = MAX_QUANTITY_PER_PERSON;
            Swal.fire({
                title: 'Error!',
                text: `You cannot add more than ${MAX_QUANTITY_PER_PERSON} of this product to the cart.`,
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    }

    function addTowishlist(productId) {
        $.ajax({
            url: `/add-to-wishlist-icon?id=${productId}`,
            type: "PUT",
            contentType: "application/json",
            success: function (response) {
                Swal.fire({
                    position: "center",
                    icon: "success",
                    title: "Added to Wishlist",
                    showConfirmButton: false,
                    timer: 1500
                });
            },
            error: function (error) {
                Swal.fire({
                    position: "center",
                    icon: "error",
                    title: "Failed to Add to Wishlist",
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        });
    }

    function addToCartDetails(productId) {
        console.log('Product ID:', productId);
    let qty = parseInt($("#qty").val()); // Ensure qty is an integer
    const availableStockElement = document.getElementById('available-stock'); // Get the available stock element
    const availableStock = parseInt(availableStockElement.value); // Ensure availableStock is an integer
    console.log('Available Stock:', availableStock);
        console.log(qty)
    // Check for valid quantity
    if (qty > MAX_QUANTITY_PER_PERSON) {
        Swal.fire({
            title: 'Error!',
            text: `You cannot add more than ${MAX_QUANTITY_PER_PERSON} of this product to the cart.`,
            icon: 'error',
            confirmButtonText: 'OK'
        });
        return;
    }

    if (qty > availableStock) {
        Swal.fire({
            title: 'Out of Stock!',
            text: `Only ${availableStock} items are available in stock.`,
            icon: 'error',
            confirmButtonText: 'OK'
        });
        return;
    }
    console.log(qty < availableStock) 

    $.ajax({
    url: "/add-to-cart",
    type: "POST",
    data: JSON.stringify({ productId, qty }), // Send as JSON string
    contentType: "application/json",
    success: function(response) {
        console.log("Response:", response); // Log the response to debug
        if (response.success) {
            // Display success message
            Swal.fire({
                position: "center",
                icon: "success",
                title: "Product added to cart",
                showConfirmButton: false,
                timer: 1500
            });

            // Update the available stock displayed on the page
            if (availableStockElement) { // Check if availableStockElement is not null or undefined
                availableStockElement.value = response.newStock;
            }
            $('.available-stock-text').text(`${response.newStock} Items In Stock`);

            // Disable the Add to Cart button if stock is zero or less
            if (response.newStock <= 0) {
                $('.button-add-to-cart').text('Out Of Stock').prop('disabled', true);
            }
        } else {
            // Display error message
            Swal.fire({
                position: "center",
                icon: "error",
                title: response.message,
                showConfirmButton: false,
                timer: 1500
            });
        }
    },
    error: function(error) {
        console.log("AJAX Error:", error); // Log the error to debug
        Swal.fire({
            position: "center",
            icon: "error",
            title: "Failed to add product to cart",
            showConfirmButton: false,
            timer: 1500
        });
    }
});
    }

</script>
    

<%- include('../layout/user/footer.ejs') %>
